<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple DApp with MetaMask</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body>
    <h1>Simple Storage DApp</h1>

    <button onclick="connectMetaMask()">Connect MetaMask</button>
    <p id="walletAddress">Not Connected</p>

    <input type="number" id="value" placeholder="Enter value">
    <button onclick="storeValue()">Store Value</button>
    <button onclick="getValue()">Get Value</button>
    <p id="output"></p>

    <script>
        let web3;
        let contract;
        let userAccount;

        const contractAddress = "0x62A120976d9002Cda6091347B5774819d6126e7a"; // Your contract address
        const abi = [
            {
                "inputs": [{"internalType": "uint256", "name": "x", "type": "uint256"}],
                "name": "set",
                "outputs": [],
                "stateMutability": "public",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "get",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ]; // Your contract ABI

        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                console.log("MetaMask is detected.");
                try {
                    console.log("Requesting MetaMask connection...");
                    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });

                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        document.getElementById("walletAddress").innerText = "Connected: " + userAccount;

                        // Initialize Web3
                        web3 = new Web3(window.ethereum);
                        contract = new web3.eth.Contract(abi, contractAddress);

                        console.log("Connected account:", userAccount);

                        // Check Network
                        const chainId = await window.ethereum.request({ method: "eth_chainId" });
                        console.log("Current Chain ID:", chainId);
                        if (chainId !== "0x89" && chainId !== "0x13881") {
                            alert("Switch to the Polygon network in MetaMask!");
                        }
                    } else {
                        alert("No accounts found. Try again.");
                    }
                } catch (error) {
                    console.error("MetaMask connection error:", error);
                    alert("Connection failed: " + error.message);
                }
            } else {
                alert("MetaMask is not installed. Redirecting...");
                window.location.href = "https://metamask.app.link/dapp/YOUR_DAPP_URL";
            }
        }

        async function storeValue() {
            if (!userAccount) {
                alert("Please connect MetaMask first.");
                return;
            }
            const value = document.getElementById("value").value;
            try {
                await contract.methods.set(value).send({ from: userAccount });
                alert("Value stored successfully.");
            } catch (error) {
                console.error("Transaction failed", error);
                alert("Transaction failed. Please check your wallet.");
            }
        }

        async function getValue() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }
            try {
                const result = await contract.methods.get().call();
                document.getElementById("output").innerText = "Stored Value: " + result;
            } catch (error) {
                console.error("Read failed", error);
                alert("Failed to read value.");
            }
        }
    </script>
</body>
</html>
